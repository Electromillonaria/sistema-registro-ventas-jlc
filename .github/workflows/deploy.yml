name: Desplegar a Hostinger

# Trigger: Se activa cuando haces push a la rama 'deploy'
on:
  push:
    branches:
      - deploy

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Clonar el repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # 2. Configurar Node.js para construir Astro
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. Instalar dependencias del proyecto
      - name: Instalar dependencias
        run: npm ci

      # 4. Construir el proyecto Astro para producciÃ³n
      - name: Construir proyecto Astro
        run: npm run build
        env:
          # Variables de entorno pÃºblicas necesarias durante el build
          # Estas deben configurarse como secretos en GitHub
          PUBLIC_API_URL: ${{ secrets.PUBLIC_API_URL }}
          PUBLIC_APP_URL: ${{ secrets.PUBLIC_APP_URL }}

      # 5. Preparar estructura de archivos para Hostinger
      - name: Preparar estructura de despliegue
        run: |
          # Crear directorio temporal para el despliegue
          mkdir -p deploy_temp
          
          # Mover contenido de dist/ a la raÃ­z del deploy_temp
          # Esto hace que index.html estÃ© en la raÃ­z de ventas/
          cp -r dist/* deploy_temp/
          
          # Copiar backend y otros archivos necesarios
          cp -r api deploy_temp/
          cp -r uploads deploy_temp/
          cp .htaccess deploy_temp/
          
          # Crear archivo .env en deploy_temp
          cat > deploy_temp/.env << EOF
          # Base de Datos (Hostinger MySQL)
          DB_CONNECTION=mysql
          DB_HOST=${{ secrets.DB_HOST }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASS }}

          # App Config
          APP_URL=${{ secrets.APP_URL }}
          API_URL=${{ secrets.API_URL }}
          ENVIRONMENT=production

          # Seguridad
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRATION=${{ secrets.JWT_EXPIRATION }}
          SETUP_SECRET=${{ secrets.SETUP_SECRET }}

          # Uploads
          UPLOAD_MAX_SIZE=${{ secrets.UPLOAD_MAX_SIZE }}
          EOF
          
          echo "âœ… Estructura preparada:"
          ls -la deploy_temp/

      # 6. Desplegar archivos vÃ­a FTP a Hostinger
      - name: Desplegar vÃ­a FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          
          # Desplegar desde el directorio preparado
          local-dir: ./deploy_temp/
          
          # Directorio remoto en Hostinger
          # Para subdominio ventas.jlc-electronics.com que apunta a public_html/ventas
          server-dir: /public_html/ventas/
          
          # ConfiguraciÃ³n de sincronizaciÃ³n
          dangerous-clean-slate: false

      # 7. VerificaciÃ³n post-despliegue
      - name: Verificar despliegue
        run: |
          echo "âœ… Despliegue completado exitosamente"
          echo "ðŸ“¦ Archivos desplegados:"
          echo "  - Frontend Astro (dist/)"
          echo "  - Backend PHP (api/)"
          echo "  - ConfiguraciÃ³n (.env, .htaccess)"
          echo "  - Directorio de uploads (uploads/)"
          echo ""
          echo "ðŸ” PrÃ³ximos pasos manuales:"
          echo "  1. Verificar que la base de datos MySQL estÃ© creada en Hostinger"
          echo "  2. Importar el schema de la base de datos"
          echo "  3. Verificar permisos del directorio uploads/ (chmod 755)"
          echo "  4. Probar la aplicaciÃ³n en tu dominio"
